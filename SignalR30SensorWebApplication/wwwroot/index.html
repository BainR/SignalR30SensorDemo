<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Sensor Dashboard</title>
    <link rel="stylesheet" href="https://ajax.aspnetcdn.com/ajax/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<body>
    <div class="container body-content">
        <h1>SignalR 3.0 Sensor Demo</h1>

        <hr />
        <div id="chart"></div>
        <ol id="messagesList"></ol>
        <hr />

        <footer>
            <p>&copy; 2018 - SignalR30SensorDemo</p>
        </footer>
    </div>

    <script src="lib/signalr/signalr.js"></script>
    <script src="lib/realTimeLineChart.js"></script>
    <script>
        const lineArray = [];
        const latestSensorData = { x: -18, y: -18, z: -18};
        const chart = realTimeLineChart();
        let olStart = 0;

        function updateGraph() {
            const now = new Date();
            const lineData = { time: now };

            Object.assign(lineData, latestSensorData);
            lineArray.push(lineData);

            if (lineArray.length > 30) {
                lineArray.shift();
            }

            d3.select("#chart").datum(lineArray).call(chart);
        }

        function addMessage(message) {
            const li = document.createElement("li");
            li.textContent = message;

            const ol = document.getElementById("messagesList");
            ol.appendChild(li);

            while (ol.childElementCount > 10) {
                ol.removeChild(ol.childNodes[0]);
                olStart++;
            }

            ol.setAttribute("start", olStart);
        }

        (async () => {
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/sensors")
                .configureLogging(signalR.LogLevel.Information)
                .build();

            await connection.start();

            const sensorNames = await connection.invoke("GetSensorNames");

            function removeSensor(sensor) {
                const index = sensorNames.indexOf(sensor);
                if (index !== -1) {
                    sensorNames.splice(index, 1);
                }
            }

            function addSensor(sensorName) {
                connection.stream("GetSensorData", sensorName)
                    .subscribe({
                        next: (item) => {
                            latestSensorData[sensorName] = item;
                            addMessage(`${sensorName}: ${item}`);
                        },
                        complete: () => {
                            addMessage(`${sensorName} Completed`);
                            removeSensor(sensorName);
                        },
                        error: (err) => {
                            addMessage(`${sensorName} error: "${err}"`);
                            removeSensor(sensorName);
                        },
                    });
            }

            sensorNames.forEach(addSensor);
            connection.on("SensorAdded", sensorName => {
                if (!sensorNames.includes(sensorName)) {
                    sensorNames.push(sensorName);
                    addSensor(sensorName);
                }
            });

            function resize() {
                if (d3.select("#chart svg").empty()) {
                    return;
                }
                chart.width(+d3.select("#chart").style("width").replace(/(px)/g, ""));
                d3.select("#chart").call(chart);
            }

            window.setInterval(updateGraph, 500);
            d3.select(window).on('resize', resize);
        })();
    </script>
</body>
</html>