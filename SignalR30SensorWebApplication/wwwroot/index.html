<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Sensor Dashboard</title>
    <link rel="stylesheet" href="https://ajax.aspnetcdn.com/ajax/bootstrap/3.3.7/css/bootstrap.min.css">
</head>
<body>
    <div class="container body-content">
        <h1>SignalR 3.0 Sensor Demo</h1>

        <hr />
        <ul id="messagesList"></ul>
        <hr />

        <footer>
            <p>&copy; 2018 - SignalR30SensorDemo</p>
        </footer>
    </div>

    <script src="lib/signalr/signalr.js"></script>
    <script>
        function addMessage(message) {
            var li = document.createElement("li");
            li.textContent = message;
            document.getElementById("messagesList").appendChild(li);
        }

        (async () => {
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/sensors")
                .configureLogging(signalR.LogLevel.Information)
                .build();

            await connection.start();

            const sensorNames = await connection.invoke("GetSensorNames");
            
            sensorNames.forEach(sensorName => {
                connection.stream("GetSensorData", sensorName)
                    .subscribe({
                        next: (item) => {
                            addMessage(`${sensorName}: ${item}`);
                        },
                        complete: () => {
                            addMessage("Stream Completed");
                        },
                        error: (err) => {
                            addMessage(`Error: "${err}"`);
                        },
                    });
            });
        })();
    </script>
</body>
</html>